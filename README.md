# Тестовое задание для VC.ru и DTF.ru

Тестовое задание выполнено с помощью технологии Docker. 

## Технические детали
- **Технологии**: PHP 8.4, Symfony 7.3, PostgreSQL 17.5, Redis 8, Nginx. Созданы 4 docker-контейнера: vc-app-1 (php приложение), vc-db-1 (БД), vc-nginx-1 (nginx), vc-redis-1 (redis).
- **База данных**: Сущности `Post` (посты - 4000 записей), `User` (пользователи - 100 записей), `UserView` (просмотры постов пользователями - 4000 записей по одному просмотру пользователя на пост) с оптимизированными индексами.
- **Кэширование**: Redis для кэширования ленты, что снижает нагрузку на БД. Время жизни кеша  - 10 секунд (допущение в рамках тестового задания для удобства проверки).
- **Тестирование**: Unit тесты в `tests/Controller/PostControllerTest.php`.
- **Автоматизация**: `docker-compose.yml` и `setup.sh` для быстрого развертывания проекта.
- **Фикстуры**: Тестовые данные с постами и пользователями (`src/DataFixtures/AppFixtures.php`).

## Инструкции по установке

# Требования
- Docker
- Docker Compose

Проект запускается как на windows так и на linux.

1. **Клонируйте репозиторий**:
   ```bash
   git clone <repository-url>
   cd <repository-directory>
   ```

2. **Запустите Docker-контейнеры**:
   ```bash
   docker-compose up -d
   ```

3. **Выполните скрипт настройки**:
   Устанавливает зависимости, создает БД, выполняет миграции, загружает фикстуры и запускает тесты:
   ```bash
   chmod +x setup.sh
   ./setup.sh
   ```

После выполнения данных действий проект будет запушен и готов к проверке.

## Возможности

- **API-эндпоинты**:
  - `GET /api/post?userId=<id>&page=<page>&limit=<limit>&sortOrder=<ASC|DESC>`: Получение пагинированной ленты постов с сортировкой по `hotness` (DESC по умолчанию), исключая просмотренные пользователем посты и посты с более чем 1000 просмотров.  Ручка имеет кеширование redis со времени жизни кеша 10 секунд (допущение в рамках тестового задания для удобства проверки).
  - `POST /api/post/{postId}/read`: Отметка просмотра поста пользователем.
- **Оптимизация**:
  - PostgreSQL с индексами B-Tree.
  - Кэширование результатов ленты в Redis для снижения нагрузки на БД.
- **Тестирование**: Функциональные тесты на PHPUnit, покрывающие успешные сценарии и краевые случаи (невалидный `userId`, повторные просмотры).
- **Автоматизация**: Удобное и быстрое развертывание через Docker Compose и `setup.sh`.

## Тестирование API
Используйте [Postman-коллекцию](dtf_api.postman_collection.json) для тестирования API. Файл коллекции лежит в корне проекта с именем vc.ru.postman_collection.

Или попробуйте примеры ниже:

- **Получение ленты**:
   ```bash
   curl "http://localhost:8080/api/post?userId=1&page=1&limit=50&sortOrder=DESC"
   ```
   Ответ:
   ```json
   {
       "status": "success",
       "data": {
           "posts": [
               {
                   "id": 1,
                   "title": "Тестовый пост",
                   "content": "Тестовое содержимое",
                   "hotness": 10.5,
                   "viewСount": 1,
                   "authorId": 2,
                   "authorName": "Игнатьев Егор",
                   "createdAt": "2025-06-29 18:00:00",
               }
           ],
           "currentPage": 1,
           "totalPages": 1,
           "totalItems": 1
       }
   }
   ```

- **Отметка просмотра поста**:
   ```bash
   curl -X POST "http://localhost:8080/api/post/1/read" -H "Content-Type: application/json" -d '{"userId": 1}'
   ```
   Ответ:
   ```json
   {
       "status": "success",
       "data": {
           "id": 1,
             "title": "Тестовый пост",
             "content": "Тестовое содержимое",
             "hotness": 10.5,
             "viewСount": 1,
             "authorId": 2,
             "authorName": "Игнатьев Егор",
             "createdAt": "2025-06-29 18:00:00",
       }
   }
   ```

## Примечания
- Проект оптимизирован с использованием Redis и индексов БД. Использованы сырые sql запросы.
- Имеется обработка ошибок.
- В качестве допущения .env файл лежит в репозитории и не игнорируется гитом для удобства проверяющих.
